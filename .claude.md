# LibreTrep - Sistema Electoral para Partido Libre Honduras

## Resumen del Proyecto

Sistema PWA de captura de actas electorales m√≥vil para elecciones primarias internas del Partido Libre de Honduras. Permite a delegados en campo capturar y digitalizar actas presidenciales, de diputados y alcaldes con validaci√≥n multi-factor y GPS.

## Estado Actual

**Fase**: ‚úÖ Desarrollo completo - üîú Listo para deployment
**√öltima actualizaci√≥n**: 1 Nov 2024
**Build**: ‚úÖ Exitoso sin errores
**Git**: ‚úÖ 4 commits, working tree limpio

## Contexto T√©cnico Importante

### Stack Tecnol√≥gico
- **Framework**: Next.js 16 (App Router + Turbopack)
- **Lenguaje**: TypeScript 5 (strict mode)
- **Database**: PostgreSQL + Prisma ORM
- **UI**: Tailwind CSS 4 + shadcn/ui
- **PWA**: next-pwa configurado
- **Deployment Target**: Railway (Europa) + Supabase (Frankfurt)

### Arquitectura de Autenticaci√≥n
El sistema usa autenticaci√≥n **multi-factor en 4 pasos**:
1. QR Code de credencial (con fallback manual)
2. DNI (13 d√≠gitos)
3. Tel√©fono (8 d√≠gitos) + SMS mock
4. GPS validation (radio 50km)

### Base de Datos
- **Escala**: 6.2M votantes, 299 municipios, 5,746 centros
- **Schema**: Prisma con tipos espec√≠ficos de PostgreSQL
- **Singleton**: `src/lib/prisma.ts` - SIEMPRE usar este import
- **Migraciones**: Listas en `prisma/migrations/`
- **Seed**: `prisma/seed.ts` con datos reales

## Decisiones de Arquitectura Cr√≠ticas

### 1. Prisma Singleton (OBLIGATORIO)
```typescript
// ‚úÖ CORRECTO
import { prisma } from '@/lib/prisma';

// ‚ùå NUNCA HACER
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
```

**Raz√≥n**: Previene agotamiento de conexiones en desarrollo y producci√≥n.

### 2. Optimizaciones Implementadas
- ‚úÖ N+1 queries eliminados (usar `createMany` en lugar de loops con `create`)
- ‚úÖ Upload validation (tipo, tama√±o 5MB, sanitizaci√≥n de nombres)
- ‚úÖ Batch inserts para votos
- ‚úÖ No usar `await prisma.$disconnect()` (el singleton lo maneja)

### 3. Campos de Prisma Schema
**IMPORTANTE**: El schema NO tiene estos campos:
- ‚ùå `qrCodeData` en modelo Acta
- ‚ùå `submittedAt` en modelo Acta
- ‚úÖ Usar `capturedAt`, `createdAt`, `updatedAt` en su lugar

### 4. Componentes Client/Server
- **QRScanner**: Named export `{ QRScanner }` - NO default
- **useSearchParams**: Requiere `<Suspense>` wrapper
- **Camera/GPS**: Solo funciona en HTTPS (requerido en producci√≥n)

## Estructura de Archivos Clave

```
libre-trep/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma.ts          ‚≠ê Singleton - usar siempre
‚îÇ   ‚îú‚îÄ‚îÄ app/api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/login/        ‚≠ê Multi-factor auth
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actas/             ‚≠ê Presidential actas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actas/additional/  ‚≠ê Deputies/Mayors
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload/            ‚≠ê Image upload (validado)
‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ       ‚îî‚îÄ‚îÄ next-pwa.d.ts      ‚≠ê TypeScript declarations
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma          ‚≠ê Database schema
‚îÇ   ‚îú‚îÄ‚îÄ seed.ts                ‚≠ê 6.2M voters
‚îÇ   ‚îî‚îÄ‚îÄ migrations/            ‚≠ê DB migrations
‚îú‚îÄ‚îÄ DATOS_PRUEBA.md            ‚≠ê Test credentials
‚îú‚îÄ‚îÄ PLAN_DEPLOYMENT.md         ‚≠ê Deployment options
‚îú‚îÄ‚îÄ PRE_DEPLOYMENT_CHECKLIST.md ‚≠ê Pre-deploy checks
‚îî‚îÄ‚îÄ PROXIMA_SESION.md          ‚≠ê Next session plan
```

## Variables de Entorno

### Desarrollo (.env)
```env
DATABASE_URL="postgresql://postgres:PASSWORD@localhost:5432/libretrep"
JWT_SECRET="development-secret-key"
NEXT_PUBLIC_APP_URL="http://localhost:3000"
GPS_RADIUS_METERS="50000"
TWILIO_ENABLED="false"
```

### Producci√≥n (Railway/Vercel)
```env
DATABASE_URL="postgresql://...supabase.co/postgres"
JWT_SECRET="[openssl rand -base64 32]"
NEXT_PUBLIC_APP_URL="https://[app].railway.app"
NODE_ENV="production"
GPS_RADIUS_METERS="50000"
TWILIO_ENABLED="false"
# Cloudflare Turnstile (pr√≥xima fase)
NEXT_PUBLIC_TURNSTILE_SITE_KEY="0x4AAA..."
TURNSTILE_SECRET_KEY="0x4AAA..."
```

## Comandos √ötiles

```bash
# Desarrollo
npm run dev              # Dev server con Turbopack
npm run build           # Production build
npm run start           # Production server

# Prisma
npx prisma generate     # Generar Prisma Client
npx prisma migrate dev  # Crear/aplicar migration
npx prisma migrate deploy # Deploy migrations (prod)
npx prisma db seed      # Poblar BD con datos
npx prisma studio       # UI para ver/editar BD

# Git
git status             # Ver estado
git log --oneline -5   # Ver √∫ltimos commits
```

## Datos de Prueba

Ver archivo `DATOS_PRUEBA.md` para credenciales completas.

**Delegado 1 (Francisco - Tegucigalpa)**:
- QR: `DEL-FM-001-2025`
- DNI: `0801199012345`
- Tel√©fono: `98765432`
- GPS: 14.0723, -87.1921

**Delegado 2 (Mar√≠a - San Pedro Sula)**:
- QR: `DEL-CORTES-001-2025`
- DNI: `0801198523456`
- Tel√©fono: `95432167`
- GPS: 15.5036, -88.0253

## Problemas Comunes y Soluciones

### Build Errors

**Error: "Export default doesn't exist"**
- Causa: Importar componente con export nombrado como default
- Soluci√≥n: `import { QRScanner }` en lugar de `import QRScanner`

**Error: "useSearchParams should be wrapped in Suspense"**
- Causa: useSearchParams en componente sin Suspense
- Soluci√≥n: Crear wrapper con `<Suspense fallback={...}>`

**Error: "qrCodeData does not exist"**
- Causa: Campo no existe en schema de Prisma
- Soluci√≥n: Remover del objeto `data` en create/update

### Runtime Errors

**Error: "Too many Prisma Clients"**
- Causa: No usar singleton de Prisma
- Soluci√≥n: Siempre `import { prisma } from '@/lib/prisma'`

**Error: "Camera not working"**
- Causa: Requiere HTTPS en producci√≥n
- Soluci√≥n: Verificar SSL/TLS en deployment

**Error: "GPS not available"**
- Causa: Permisos de ubicaci√≥n o HTTPS faltante
- Soluci√≥n: Verificar permisos del navegador + HTTPS

## Pr√≥ximos Pasos (Para Siguiente Sesi√≥n)

### Prioridad 1 - Deployment
1. Crear repo en GitHub
2. Setup Supabase PostgreSQL (Frankfurt)
3. Deploy a Railway (Europa) o Vercel
4. Ejecutar migraciones en Supabase
5. Ejecutar seed (6.2M voters)
6. Testing desde m√≥vil

### Prioridad 2 - Seguridad (Opcional)
1. Configurar Cloudflare Turnstile
2. Implementar rate limiting
3. Configurar dominio personalizado

Ver `PROXIMA_SESION.md` para plan detallado paso a paso.

## Restricciones y Consideraciones

### PostgreSQL Obligatorio
El schema de Prisma usa tipos espec√≠ficos de PostgreSQL:
- Arrays de JSON
- Tipos enum personalizados
- No compatible con MySQL/SQLite

### HTTPS Obligatorio en Producci√≥n
APIs del navegador requieren HTTPS:
- Geolocation API (GPS)
- getUserMedia (C√°mara)
- Service Workers (PWA)

### Regi√≥n Europa Preferida
- Mejor latencia para Honduras que US East
- Cumplimiento GDPR
- Supabase Frankfurt recomendado
- Railway eu-west como alternativa

## Contacto y Prop√≥sito

**Cliente**: Partido Libre - Honduras
**Prop√≥sito**: Captura de actas electorales para primarias internas
**Escala**: Miles de delegados en campo simult√°neamente
**Requisitos Cr√≠ticos**: Offline-first, validaci√≥n GPS, multi-factor auth

## Documentaci√≥n Adicional

- `README.md` - Setup y desarrollo
- `DATOS_PRUEBA.md` - Credenciales de testing
- `PLAN_DEPLOYMENT.md` - Opciones de deployment detalladas
- `PRE_DEPLOYMENT_CHECKLIST.md` - Verificaciones cr√≠ticas
- `PROXIMA_SESION.md` - Plan para deployment
- `RESUMEN_SESION_HOY.md` - Logros de √∫ltima sesi√≥n

---

**√öltima compilaci√≥n exitosa**: 1 Nov 2024
**Estado del proyecto**: üü¢ Listo para deployment
**Siguiente milestone**: Deployment a producci√≥n + testing m√≥vil
